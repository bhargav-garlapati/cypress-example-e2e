steps:
  # Clone the repository
  - name: 'gcr.io/cloud-builders/git'
    args: ['clone', '${_REPO_URL}', '--branch', '${_BRANCH}', '.']

  # Install dependencies
  - name: 'node:20'
    args: ['npm', 'ci']

  # Get secrets from Secret Manager
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud secrets versions access latest --secret=cypress-environment-variables > cypress.env.json

  # Make script executable
  - name: 'debian:stable-slim'
    args: ['chmod', '+x', 'run-cypress.sh']

  # Run Cypress tests
  - name: 'cypress/included:14.3.0'
    entrypoint: './run-cypress.sh'
    args: ['${_ENV}', '${_SPECS}', '${_CONTAINER_IDX}', '${BUILD_ID}', '${_CYPRESS_RECORD_KEY}', '${_TAGS}']
    env:
      - 'CI_PLATFORM=gcp'
      - 'CI_SERVICE=cloud-build'
      - 'TOTAL_CONTAINERS=${_TOTAL_CONTAINERS}'
      - 'PERCY_TOKEN=${_PERCY_TOKEN}'
      - 'PROJECT_TOKEN=${_PROJECT_TOKEN}'

  # Upload results to GCS
  - name: 'gcr.io/cloud-builders/gsutil'
    args: ['-m', 'cp', '-r', 'cypress/results', 'gs://cypress-example-e2e-results/${BUILD_ID}/']

substitutions:
  _ENV: 'production'  # Default environment
  _SPECS: 'all'       # Default specs to run
  _CONTAINER_IDX: '1'  # Default container index
  _TOTAL_CONTAINERS: '2'  # Default total containers, will be overridden by GitHub Actions
  _REPO_URL: 'https://github.com/bhargav-garlapati/cypress-example-e2e.git'  # Default repo URL
  _BRANCH: 'main'  # Default branch
  _CYPRESS_RECORD_KEY: ''  # Default empty value, will be overridden by GitHub Actions
  _TAGS: ''  # Default empty value for tags
  _PERCY_TOKEN: ''  # Default empty value for Percy token
  _PROJECT_TOKEN: ''  # Default empty value for SmartUI token

timeout: 1800s  # 30 minutes
